import math
import numpy as np


def transition(carbon_K: float, pt1000_K: float, transition_K=30.0):
    """
    https://kitchingroup.cheme.cmu.edu/blog/2013/01/31/Smooth-transitions-between-discontinuous-functions/
    """
    alpha_K = 2.0  # 2.0 : changes over about +- 10K, do not change
    sigma = 1.0 / (1 + math.exp(-(pt1000_K - transition_K) / alpha_K))
    calibrated_K = (1 - sigma) * carbon_K + sigma * pt1000_K
    return calibrated_K


class Calibration:
    PT1000_30C_OHM = 1116.73
    ZEROCELSIUS_K = 273.15

    def __init__(self, carbon_OHM: float, pt1000_OHM: float) -> None:
        self.carbon_OHM = carbon_OHM
        self.pt1000_OHM = pt1000_OHM
        # The following line corresponds to
        # micropython_portable.py::ThermometriePT1000.temperature_C()
        # self.carbon_K = self.ZEROCELSIUS_K + (pt1000_OHM - 1000.0) * 30.0 / (self.PT1000_30C_OHM - 1000.0)
        # self.pt1000_K = self.carbon_K
        # self.carbon_K = np.interp()
        """
        for calibration the data measured is between 1.29K and 255K. Outside of this range extrapolated linearly.
        """
        self.carbon_K = np.interp(
            self.carbon_OHM, R_calibration_carbon, T_calibration_carbon
        )
        self.pt1000_K = np.interp(
            self.pt1000_OHM, R_calibration_pt1000, T_calibration_pt1000
        )
        self.calibrated_K = transition(
            carbon_K=self.carbon_K, pt1000_K=self.pt1000_K, transition_K=30.0
        )


def main():
    print("real_K, carbon_K, pt1000_K, calibrated_K, calibrated_K-real_K")
    for real_K in range(300):
        carbon_K = real_K - 1.0
        pt1000_K = real_K + 1.0
        calibrated_K = transition(carbon_K, pt1000_K)
        print(
            f"{real_K:0.3f}, {carbon_K:0.3f}, {pt1000_K:0.3f}, {calibrated_K:0.3f}, {calibrated_K-real_K:0.3f}"
        )


if __name__ == "__main__":
    main()

# First calibration 2022-05 Lev Ginzbourg
T_calibration_carbon = np.array(
    [
        1.06435,
        1.17629,
        1.30000,
        1.43672,
        1.58782,
        1.75482,
        1.93937,
        2.14334,
        2.36875,
        2.61788,
        2.89320,
        3.19748,
        3.53377,
        3.90542,
        4.31615,
        4.77009,
        5.27176,
        5.82620,
        6.43894,
        7.11613,
        7.86454,
        8.69166,
        9.60577,
        10.61602,
        11.73252,
        12.96644,
        14.33013,
        15.83724,
        17.50286,
        19.34365,
        21.37804,
        23.62639,
        26.11120,
        28.85734,
        31.89229,
        35.24643,
        38.95333,
        43.05009,
        47.57770,
        52.58150,
        58.11154,
        64.22318,
        70.97760,
        78.44237,
        86.69223,
        95.80973,
        105.88613,
        117.02227,
        129.32961,
        142.93132,
        157.96354,
        174.57671,
        192.93711,
        213.22848,
        235.65391,
        260.43785,
        287.82834,
        318.09951,
    ]
)
T_calibration_carbon = T_calibration_carbon[::-1]
R_calibration_carbon = np.array(
    [
        296.66955,
        289.75327,
        282.10959,
        273.66203,
        264.64185,
        255.95846,
        247.56113,
        239.44592,
        231.49846,
        224.10884,
        217.14596,
        210.58688,
        204.53359,
        198.85194,
        193.35700,
        188.16381,
        183.68276,
        179.19864,
        174.91593,
        170.85919,
        167.14974,
        163.62996,
        160.34116,
        157.19341,
        154.19747,
        151.40087,
        148.73913,
        146.21374,
        143.80728,
        141.54120,
        139.29847,
        137.19751,
        135.24803,
        133.34126,
        131.46785,
        129.69602,
        127.96615,
        126.31410,
        124.70856,
        123.16347,
        121.69107,
        120.25353,
        118.86642,
        117.52603,
        116.22980,
        114.98278,
        113.78816,
        112.62613,
        111.51852,
        110.43824,
        109.40277,
        108.38067,
        107.39834,
        106.40289,
        105.39096,
        104.27261,
        103.03664,
        101.67068,
    ]
)
R_calibration_carbon = R_calibration_carbon[::-1]
T_calibration_pt1000 = np.array(
    [
        1.30000,
        6.30000,
        11.30000,
        16.30000,
        21.30000,
        26.30000,
        31.30000,
        36.30000,
        41.30000,
        46.30000,
        51.30000,
        56.30000,
        61.30000,
        66.30000,
        71.30000,
        76.30000,
        81.30000,
        86.30000,
        91.30000,
        96.30000,
        101.30000,
        106.30000,
        111.30000,
        116.30000,
        121.30000,
        126.30000,
        131.30000,
        136.30000,
        141.30000,
        146.30000,
        151.30000,
        156.30000,
        161.30000,
        166.30000,
        171.30000,
        176.30000,
        181.30000,
        186.30000,
        191.30000,
        196.30000,
        201.30000,
        206.30000,
        211.30000,
        216.30000,
        221.30000,
        226.30000,
        231.30000,
        236.30000,
        241.30000,
        246.30000,
        251.30000,
        256.30000,
        261.30000,
        266.30000,
        271.30000,
        276.30000,
        281.30000,
        286.30000,
        291.30000,
        296.30000,
        301.30000,
        306.30000,
        311.30000,
        316.30000,
        321.30000,
        326.30000,
        331.30000,
        336.30000,
        341.30000,
        346.30000,
    ]
)
R_calibration_pt1000 = np.array(
    [
        6.14923,
        6.43328,
        7.03783,
        8.75956,
        12.34746,
        18.35155,
        27.30080,
        39.15381,
        53.62106,
        70.32334,
        88.67341,
        108.12989,
        128.38398,
        149.33975,
        170.76092,
        192.32302,
        214.00948,
        235.67271,
        257.41188,
        279.11628,
        300.71897,
        322.25565,
        343.75067,
        365.07493,
        386.26176,
        407.44991,
        428.48039,
        449.38209,
        470.27594,
        491.04140,
        511.81061,
        532.43452,
        553.08185,
        573.68835,
        594.27345,
        614.87558,
        635.59530,
        655.40601,
        675.20413,
        695.32791,
        715.54259,
        736.06008,
        756.57475,
        777.08510,
        797.55057,
        818.09245,
        838.47464,
        859.01934,
        879.49503,
        899.65847,
        919.79035,
        939.92224,
        960.05412,
        980.18600,
        1000.31788,
        1020.44977,
        1040.58165,
        1060.71353,
        1080.84542,
        1100.97730,
        1121.10918,
        1141.24106,
        1161.37295,
        1181.50483,
        1201.63671,
        1221.76860,
        1241.90048,
        1262.03236,
        1282.16424,
        1302.29613,
    ]
)
